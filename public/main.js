function Buffer(){this.reset(),this._onMinuteMarker=null,this._onSignal=null,this._onFull=null}function Bufferstrip(t){this._el=document.querySelector(t)}function Clock(t,i,e){this._ctx=document.querySelector(t).getContext("2d"),this._colors=i,this._sizes=e,this._time={hour:0,minute:0,second:0},this._secondInterval=null}function Clockface(t,i,e){this._ctx=document.querySelector(t).getContext("2d"),this._colors=i,this._sizes=e}function Resultview(t,i,e,s){this._errorContainerEl=document.querySelector(t),this._contentContainerEl=document.querySelector(i),this._errorEl=document.querySelector(e),["dow","day","month","year","hour","minute","timezone","cest","cet","leaps"].forEach(function(t){this["_"+t+"El"]=document.querySelector(s[t])}.bind(this))}function Signal(t){this._rawData=t,this.parseData()}function Statusstrip(t){this._el=document.querySelector(t)}function checkParity(t,i){return((t+i).split("1").length-1)%2===0}function padString(t,i){for(var e=t.toString();e.length<i;)e="0"+e;return e}window.app={settings:{colors:{clock:{progress:{hour:"rgb(15, 59, 82)",minute:"rgb(64, 125, 55)",second:"rgb(47, 82, 60)"}},clockface:{labels:{hour:"rgba(247, 236, 192, 0.3)",minute:"rgba(247, 236, 192, 0.2)"},markers:{hour:"rgb(247, 236, 192)",minute:"rgba(247, 236, 192, 0.5)"}}},sizes:{clock:{clock:{height:500,width:1e3},progress:{hour:{line:15},minute:{line:15},second:{line:15}}},clockface:{clock:{height:500,width:1e3},font:{hour:{size:16,margin:80},minute:{size:13,margin:15}},markers:{hour:{line:2,height:60,shortHeight:15},minute:{line:1,height:45}}}}},buffer:null,oldBuffer:null,bufferstrip:null,clock:null,clockface:null,oldbufferstrip:null,resultview:null,statusstrip:null,socketio:null,init:function(){this.bufferstrip=new Bufferstrip("#buffer"),this.clock=new Clock("#clock",this.settings.colors.clock,this.settings.sizes.clock),this.clockface=new Clockface("#clockface",this.settings.colors.clockface,this.settings.sizes.clockface),this.oldbufferstrip=new Bufferstrip("#oldBuffer"),this.resultview=new Resultview("#errorContent","#dataContent","#error",{dow:"#dow",day:"#day",month:"#month",year:"#year",hour:"#hour",minute:"#minute",timezone:"#timezone",cest:"#cest",cet:"#cet",leaps:"#leaps"}),this.statusstrip=new Statusstrip("#status"),this.bufferstrip.clear(),this.oldbufferstrip.clear(),this.clock.init(),this.clockface.init(),this.resultview.setErrorNoData(),this.statusstrip.setWaiting(),this.newBuffer(),this.oldBuffer=new Buffer,this.socketio=io.connect(SOCKETIO_ADDRESS),this.socketio.on("dcf77signal",this.buffer.receiveSignal.bind(this.buffer)),window.setTimeout(this.clockface.draw.bind(this.clockface),500)},newBuffer:function(){this.buffer=new Buffer,this.buffer.onMinuteMarker(function(){if(this.clock.restartTicking(),this.bufferstrip.clear(),this.statusstrip.setReceiving(),this.oldBuffer.isFull())if(this.oldbufferstrip.fill(this.oldBuffer),this.oldBuffer.isValid()){var t=this.oldBuffer.toObject(),i=BCD.toDecimalR(t.hour),e=BCD.toDecimalR(t.minute);this.clock.setTime(i,e),this.resultview.setData(t)}else this.resultview.setErrorInvalidData()}.bind(this)),this.buffer.onSignal(function(t,i){t&&this.bufferstrip.append(i.getValue())}.bind(this)),this.buffer.onFull(function(t){this.statusstrip.setWaiting(),this.oldBuffer.fromString(t),t.reset()}.bind(this))}},document.addEventListener("DOMContentLoaded",function(){app.init()}),Buffer.prototype={receiveSignal:function(t){t=new Signal(t),!this._initiated&&t.isMinuteMarker()&&(this._initiated=!0,this._onMinuteMarker&&this._onMinuteMarker(this)),this._initiated&&!this._full?(this._signals.push(t),this._onSignal&&this._onSignal(!0,t),this._signals.length>=59&&(this._full=!0,this._onFull&&this._onFull(this))):this._onSignal&&this._onSignal(!1,t)},reset:function(){this._signals=[],this._initiated=!1,this._full=!1},toString:function(){return this._signals.join("")},toObject:function(){var t=this._signals.join("");if(!t||59!=t.length)return!1;var i=t.substr.bind(t);return{minuteMarker:i(0,1),weather:i(1,14),callingbit:i(15,1),timezone:i(16,1),cest:i(17,1),cet:i(18,1),leaps:i(19,1),timestart:i(20,1),minute:i(21,7),minuteP:i(28,1),hour:i(29,6),hourP:i(35,1),day:i(36,6),dow:i(42,3),month:i(45,5),year:i(50,8),dateP:i(58,1)}},isFull:function(){return 59==this._signals.length},isValid:function(){var t=this.toObject();return t?checkParity(t.minute,t.minuteP)&&checkParity(t.hour,t.hourP)&&checkParity([t.day,t.dow,t.month,t.year].join(""),t.dateP):!1},fromString:function(t){this.reset(),this._signals=t.toString().split(""),this._signals.length>=59&&(this._full=!0)},onMinuteMarker:function(t){this._onMinuteMarker=t},onSignal:function(t){this._onSignal=t},onFull:function(t){this._onFull=t}},Bufferstrip.prototype={clear:function(){this._el.innerHTML=""},append:function(t){this._el.innerHTML+=t.toString()},fill:function(t){this._el.innerHTML=t.toString()}},Clock.prototype={init:function(){this.initCanvas(),this.redraw()},redraw:function(){this.clearCanvas(),this.drawCurrentHour(),this.drawCurrentMinute(),this.drawCurrentSecond()},clearCanvas:function(){this._ctx.clearRect(-this._sizes.clock.width,0,2*this._sizes.clock.width,this._sizes.clock.height)},initCanvas:function(){this._ctx.translate(this._sizes.clock.height,this._sizes.clock.height),this._ctx.rotate(-Math.PI),this._ctx.lineCap="butt",this._ctx.textAlign="center"},drawCurrentHour:function(){this._ctx.strokeStyle=this._colors.progress.hour,this._ctx.fillStyle=this._ctx.strokeStyle,this._ctx.lineWidth=this._sizes.progress.hour.line,this._ctx.save(),this._ctx.beginPath();var t=0===this._time.hour?Math.PI:Math.PI*(this._time.hour/24);this._ctx.arc(0,0,this._sizes.clock.height-this._sizes.progress.hour.line/2,0,t,!1),this._ctx.stroke(),this._ctx.restore()},drawCurrentMinute:function(){this._ctx.strokeStyle=this._colors.progress.minute,this._ctx.fillStyle=this._ctx.strokeStyle,this._ctx.lineWidth=this._sizes.progress.minute.line,this._ctx.save(),this._ctx.beginPath();var t=0===this._time.minute?Math.PI:Math.PI*(this._time.minute/60);this._ctx.arc(0,0,this._sizes.clock.height-3*this._sizes.progress.minute.line/2,0,t,!1),this._ctx.stroke(),this._ctx.restore()},drawCurrentSecond:function(){this._ctx.strokeStyle=this._colors.progress.second,this._ctx.fillStyle=this._ctx.strokeStyle,this._ctx.lineWidth=this._sizes.progress.second.line,this._ctx.save(),this._ctx.beginPath();var t=0===this._time.second?Math.PI:Math.PI*(this._time.second/60);this._ctx.arc(0,0,this._sizes.clock.height-5*this._sizes.progress.second.line/2,0,t,!1),this._ctx.stroke(),this._ctx.restore()},setTime:function(t,i){this._time.hour=parseInt(t),this._time.minute=parseInt(i),this.redraw()},tick:function(){this._time.second+=1,this._time.second>59&&this.stopTicking(),this.redraw()},startTicking:function(){this._time.second=0,this._secondInterval=window.setInterval(this.tick.bind(this),1e3)},stopTicking:function(){this._secondInterval&&window.clearInterval(this._secondInterval),this._secondInterval=null},restartTicking:function(){this.stopTicking(),this.startTicking()}},Clockface.prototype={init:function(){this.initCanvas()},draw:function(){this.clearCanvas(),this.drawHourMarks(),this.drawMinuteMarks(),this.drawHourLineLabels(),this.drawClockBorder()},clearCanvas:function(){this._ctx.clearRect(-this._sizes.clock.width,0,2*this._sizes.clock.width,this._sizes.clock.height)},initCanvas:function(){this._ctx.translate(this._sizes.clock.height,this._sizes.clock.height),this._ctx.rotate(-Math.PI),this._ctx.lineCap="butt",this._ctx.textAlign="center"},drawHourMarks:function(){this._ctx.strokeStyle=this._colors.markers.hour,this._ctx.fillStyle=this._ctx.strokeStyle,this._ctx.lineWidth=this._sizes.markers.hour.line,this._ctx.save();for(var t=0;24>=t;t++)this._ctx.beginPath(),t%2!==0?this._ctx.moveTo(this._sizes.clock.height-this._sizes.markers.hour.shortHeight,0):this._ctx.moveTo(this._sizes.clock.height-this._sizes.markers.hour.height,0),this._ctx.lineTo(this._sizes.clock.height,0),this._ctx.stroke(),this._ctx.rotate(Math.PI/24);this._ctx.restore()},drawClockBorder:function(){this._ctx.strokeStyle=this._colors.markers.hour,this._ctx.fillStyle=this._ctx.strokeStyle,this._ctx.lineWidth=this._sizes.markers.hour.line,this._ctx.save(),this._ctx.beginPath(),this._ctx.arc(0,0,this._sizes.clock.height-this._sizes.markers.hour.line/2,0,Math.PI,!1),this._ctx.stroke(),this._ctx.restore()},drawHourLineLabels:function(){this._ctx.save(),this._ctx.rotate(Math.PI/2);for(var t=0;24>=t;t++)t>0&&24>t&&(this._ctx.strokeStyle=this._colors.labels.hour,this._ctx.fillStyle=this._ctx.strokeStyle,this._ctx.font="normal "+this._sizes.font.hour.size+'px "OpenSans"',this._ctx.fillText(t,0,-(this._sizes.clock.height-this._sizes.font.hour.margin)),2.5*t%1===0&&(this._ctx.strokeStyle=this._colors.labels.minute,this._ctx.fillStyle=this._ctx.strokeStyle,this._ctx.font="normal "+this._sizes.font.minute.size+'px "OpenSans"',this._ctx.fillText(2.5*t,0,-(this._sizes.clock.height-(this._sizes.font.hour.margin+this._sizes.font.minute.margin))))),this._ctx.rotate(Math.PI/24);this._ctx.restore()},drawMinuteMarks:function(){this._ctx.strokeStyle=this._colors.markers.minute,this._ctx.fillStyle=this._ctx.strokeStyle,this._ctx.lineWidth=this._sizes.markers.minute.line,this._ctx.save();for(var t=0;60>t;t++)t%5!==0&&(this._ctx.beginPath(),this._ctx.moveTo(this._sizes.clock.height-this._sizes.markers.minute.height,0),this._ctx.lineTo(this._sizes.clock.height,0),this._ctx.stroke()),this._ctx.rotate(Math.PI/60);this._ctx.restore()}},Resultview.prototype={daysOfWeek:[,"Mon","Tue","Wed","Thu","Fri","Sat","Sun"],setData:function(t){this._dowEl.innerHTML=this.daysOfWeek[BCD.toDecimalR(t.dow)],["day","month","year","hour","minute"].forEach(function(i){this["_"+i+"El"].innerHTML=padString(BCD.toDecimalR(t[i]),2)}.bind(this)),["timezone","cest","cet","leaps"].forEach(function(i){this["_"+i+"El"].className="1"===t[i]?"active":""}.bind(this)),this.showContentContainer()},setErrorNoData:function(){this.showErrorContainer(),this._errorEl.innerHTML="No dataset received so far..."},setErrorInvalidData:function(){this.showErrorContainer(),this._errorEl.innerHTML="Received an invalid dataset!"},showErrorContainer:function(){this._errorContainerEl.style.display="block",this._contentContainerEl.style.display="none"},showContentContainer:function(){this._contentContainerEl.style.display="block",this._errorContainerEl.style.display="none"}},Signal.prototype={splitRegex:/^\[(\d*)\|(\d*)\]$/i,parseData:function(){var t=this._rawData.match(this.splitRegex);this._signalBreak=t[1],this._signalLength=t[2]},getValue:function(){return this._signalLength>150?1:0},isMinuteMarker:function(){return this._signalBreak>1500?!0:!1},toString:function(){return this.getValue().toString()}},Statusstrip.prototype={setWaiting:function(){this._el.innerHTML="Patience please... Waiting for a minute marker..."},setReceiving:function(){this._el.innerHTML="Receiving data..."}};var BCD={toDecimal:function(t){for(var i,e="";(i=parseInt(t.substr(-4),2))===parseInt(i);)t=t.substr(0,t.length-4),i>9&&(i=9),e=i.toString()+e;return parseInt(e)},toDecimalR:function(t){return BCD.toDecimal(t.split("").reverse().join(""))},toBcd:function(t){var i="";return t=t.toString().split(""),t.forEach(function(t){for(t=parseInt(t).toString(2);t.length<4;)t="0"+t;i+=t}),i}};